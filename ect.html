<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGazer Eye Tracking - ƒêi·ªÅu khi·ªÉn b·∫±ng m·∫Øt</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            font-size: 18px;
            margin-top: 10px;
            text-align: center;
            max-width: 500px;
        }

        /* Calibration Screen */
        #calibrationScreen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 9999;
        }

        #calibrationScreen.active {
            display: block;
        }

        .calibration-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10001;
            max-width: 600px;
            padding: 40px;
        }

        .calibration-info h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #00ff88;
        }

        .calibration-info p {
            font-size: 18px;
            margin: 15px 0;
            opacity: 0.9;
            line-height: 1.6;
        }

        .calibration-info button {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 20px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .calibration-info button:hover {
            background: #00dd77;
            transform: scale(1.05);
        }

        .calibration-point {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ff6b6b 0%, #ff4757 100%);
            border: 5px solid white;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            animation: pulse 1s infinite;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
            display: none;
            z-index: 10000;
        }

        .calibration-point.active {
            display: block;
        }

        .calibration-point::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
        }

        .calibration-progress {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 10001;
            display: none;
        }

        .calibration-progress.active {
            display: block;
        }

        /* Main App */
        #mainApp {
            display: none;
            position: fixed;
            inset: 0;
        }

        #mainApp.active {
            display: block;
        }

        /* Hide WebGazer video and canvas */
        #webgazerVideoFeed {
            display: none !important;
        }

        #webgazerFaceFeedbackBox {
            display: none !important;
        }

        #webgazerFaceOverlay {
            display: none !important;
        }

        /* Custom Video Preview */
        #videoPreview {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            border: 3px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
        }

        #videoPreview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Gaze Cursor */
        #gazeCursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 3px solid #00ff88;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            background: radial-gradient(circle, rgba(0, 255, 136, 0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            display: none;
        }

        #gazeCursor.active {
            display: block;
        }

        #gazeCursor.clicking {
            animation: clickEffect 0.3s ease;
            border-color: #ff6b6b;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
        }

        @keyframes clickEffect {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.8); }
        }

        /* Status Panel */
        #statusPanel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            color: white;
            z-index: 100;
            min-width: 280px;
        }

        #statusPanel h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .status-item {
            margin: 12px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .status-indicator.active {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .panel-button {
            margin-top: 15px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s;
        }

        .panel-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* Target Boxes */
        #targetContainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(3, 150px);
            gap: 20px;
            z-index: 10;
        }

        .target-box {
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .target-box:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            border-color: #00ff88;
        }

        .target-box.gazed {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            transform: scale(1.1);
        }

        .target-box.clicked {
            animation: targetClick 0.5s ease;
        }

        @keyframes targetClick {
            0%, 100% { transform: scale(1); }
            50% { 
                transform: scale(0.9); 
                background: rgba(255, 107, 107, 0.4);
            }
        }

        .target-label {
            font-size: 12px;
            color: white;
            margin-top: 10px;
            opacity: 0.7;
        }

        /* Instructions */
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            font-size: 14px;
        }

        #instructions strong {
            color: #00ff88;
        }

        /* Accuracy Display */
        #accuracyDisplay {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        #accuracyDisplay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div id="loadingText">ƒêang kh·ªüi t·∫°o WebGazer.js...</div>
    </div>

    <!-- Calibration Screen -->
    <div id="calibrationScreen">
        <div class="calibration-info" id="calibrationInfo">
            <h2>üëÅÔ∏è Hi·ªáu chu·∫©n Eye Tracking</h2>
            <p>WebGazer.js c·∫ßn b·∫°n hi·ªáu chu·∫©n ƒë·ªÉ theo d√µi ch√≠nh x√°c √°nh m·∫Øt.</p>
            <p><strong>C√°ch l√†m:</strong> Click v√†o 9 ƒëi·ªÉm ƒë·ªè xu·∫•t hi·ªán tr√™n m√†n h√¨nh trong khi nh√¨n v√†o ch√∫ng.</p>
            <p><strong>M·∫πo:</strong> Gi·ªØ ƒë·∫ßu ·ªïn ƒë·ªãnh v√† nh√¨n th·∫≠t k·ªπ v√†o t√¢m c·ªßa m·ªói ƒëi·ªÉm.</p>
            <button id="startCalibration">B·∫Øt ƒë·∫ßu hi·ªáu chu·∫©n</button>
        </div>

        <div class="calibration-progress" id="calibrationProgress">
            Click v√†o ƒëi·ªÉm: <span id="currentPoint">0</span> / 9
        </div>

        <!-- 9 calibration points -->
        <div class="calibration-point" id="point-0" style="left: 10%; top: 10%;"></div>
        <div class="calibration-point" id="point-1" style="left: 50%; top: 10%;"></div>
        <div class="calibration-point" id="point-2" style="left: 90%; top: 10%;"></div>
        <div class="calibration-point" id="point-3" style="left: 10%; top: 50%;"></div>
        <div class="calibration-point" id="point-4" style="left: 50%; top: 50%;"></div>
        <div class="calibration-point" id="point-5" style="left: 90%; top: 50%;"></div>
        <div class="calibration-point" id="point-6" style="left: 10%; top: 90%;"></div>
        <div class="calibration-point" id="point-7" style="left: 50%; top: 90%;"></div>
        <div class="calibration-point" id="point-8" style="left: 90%; top: 90%;"></div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <!-- Video Preview -->
        <div id="videoPreview">
            <video id="customVideo" autoplay playsinline muted></video>
        </div>

        <!-- Gaze Cursor -->
        <div id="gazeCursor"></div>

        <!-- Status Panel -->
        <div id="statusPanel">
            <h3>üìä WebGazer Status</h3>
            <div class="status-item">
                <span class="status-indicator" id="trackingIndicator"></span>
                <span>Tracking: <span id="trackingStatus">Kh·ªüi ƒë·ªông...</span></span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="predictionIndicator"></span>
                <span>Predictions: <span id="predictionCount">0</span></span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="clickIndicator"></span>
                <span>Clicks: <span id="clickCount">0</span></span>
            </div>
            <button class="panel-button" id="recalibrateBtn">üéØ Hi·ªáu chu·∫©n l·∫°i</button>
            <button class="panel-button" id="togglePrecisionBtn">üîç Toggle Precision Mode</button>
        </div>

        <!-- Target Boxes -->
        <div id="targetContainer">
            <div class="target-box" data-id="1">üéØ<div class="target-label">Target 1</div></div>
            <div class="target-box" data-id="2">‚≠ê<div class="target-label">Target 2</div></div>
            <div class="target-box" data-id="3">üíé<div class="target-label">Target 3</div></div>
            <div class="target-box" data-id="4">üé®<div class="target-label">Target 4</div></div>
            <div class="target-box" data-id="5">üöÄ<div class="target-label">Target 5</div></div>
            <div class="target-box" data-id="6">üéµ<div class="target-label">Target 6</div></div>
            <div class="target-box" data-id="7">üåà<div class="target-label">Target 7</div></div>
            <div class="target-box" data-id="8">üî•<div class="target-label">Target 8</div></div>
            <div class="target-box" data-id="9">‚ú®<div class="target-label">Target 9</div></div>
        </div>

        <!-- Instructions -->
        <div id="instructions">
            <strong>üëÅÔ∏è Nh√¨n</strong> v√†o c√°c √¥ ƒë·ªÉ highlight | 
            <strong>‚è±Ô∏è Nh√¨n 1.5 gi√¢y</strong> ƒë·ªÉ click (dwell time)
        </div>

        <!-- Accuracy Display -->
        <div id="accuracyDisplay">
            Accuracy: <span id="accuracyValue">--</span> px | 
            Precision: <span id="precisionValue">--</span> px
        </div>
    </div>

    <script>
        let predictionCount = 0;
        let clickCount = 0;
        let currentGazeX = 0;
        let currentGazeY = 0;
        let calibrationStep = 0;
        let isCalibrating = false;
        let dwellTimers = {};
        const DWELL_TIME = 1500; // 1.5 seconds
        let precisionMode = false;

        async function init() {
            console.log('üöÄ Initializing WebGazer...');
            
            try {
                // Setup WebGazer
                await webgazer.setRegression('ridge')
                    .setTracker('TFFacemesh')
                    .setGazeListener((data, timestamp) => {
                        if (data == null) return;
                        
                        currentGazeX = data.x;
                        currentGazeY = data.y;
                        
                        updateGazeCursor(data.x, data.y);
                        checkGazeTargets(data.x, data.y);
                        
                        predictionCount++;
                        if (predictionCount % 10 === 0) {
                            document.getElementById('predictionCount').textContent = predictionCount;
                        }
                    })
                    .saveDataAcrossSessions(true)
                    .begin();

                // Hide default WebGazer elements
                webgazer.showVideoPreview(false)
                    .showPredictionPoints(false)
                    .showFaceOverlay(false)
                    .showFaceFeedbackBox(false);

                console.log('‚úÖ WebGazer initialized!');
                
                // Wait a bit for camera to be ready
                await sleep(1500);
                
                // Setup custom video preview
                setupCustomVideoPreview();
                
                // Hide loading, show calibration
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('calibrationScreen').classList.add('active');
                
                // Setup buttons
                document.getElementById('startCalibration').addEventListener('click', startCalibration);
                document.getElementById('recalibrateBtn').addEventListener('click', recalibrate);
                document.getElementById('togglePrecisionBtn').addEventListener('click', togglePrecisionMode);
                
                // Update status
                document.getElementById('trackingStatus').textContent = 'S·∫µn s√†ng';
                document.getElementById('trackingIndicator').classList.add('active');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                document.getElementById('loadingText').innerHTML = `
                    <div style="color: #ff6b6b; margin-bottom: 15px;">‚ùå L·ªói kh·ªüi t·∫°o</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">${error.message}</div>
                    <button onclick="location.reload()" style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">üîÑ Th·ª≠ l·∫°i</button>
                `;
            }
        }

        function setupCustomVideoPreview() {
            const video = document.getElementById('webgazerVideoFeed');
            const customVideo = document.getElementById('customVideo');
            
            if (video && video.srcObject) {
                customVideo.srcObject = video.srcObject;
            }
        }

        function startCalibration() {
            console.log('üìç Starting calibration...');
            isCalibrating = true;
            calibrationStep = 0;
            
            document.getElementById('calibrationInfo').style.display = 'none';
            document.getElementById('calibrationProgress').classList.add('active');
            
            showCalibrationPoint(0);
        }

        function showCalibrationPoint(index) {
            if (index >= 9) {
                finishCalibration();
                return;
            }
            
            document.getElementById('currentPoint').textContent = index + 1;
            
            const point = document.getElementById(`point-${index}`);
            point.classList.add('active');
            
            let clicksNeeded = 5;
            let clicks = 0;
            
            point.onclick = () => {
                clicks++;
                console.log(`üìç Calibration point ${index + 1}, click ${clicks}/${clicksNeeded}`);
                
                if (clicks >= clicksNeeded) {
                    point.classList.remove('active');
                    point.onclick = null;
                    
                    setTimeout(() => {
                        showCalibrationPoint(index + 1);
                    }, 300);
                }
            };
        }

        function finishCalibration() {
            console.log('‚úÖ Calibration complete!');
            isCalibrating = false;
            
            document.getElementById('calibrationScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            
            // Show gaze cursor
            document.getElementById('gazeCursor').classList.add('active');
            
            // Start prediction indicator
            document.getElementById('predictionIndicator').classList.add('active');
            
            console.log('üëÅÔ∏è WebGazer is now tracking!');
        }

        function recalibrate() {
            console.log('üîÑ Recalibrating...');
            
            // Reset calibration points
            document.querySelectorAll('.calibration-point').forEach(point => {
                point.classList.remove('active');
                point.onclick = null;
            });
            
            // Reset progress
            document.getElementById('calibrationInfo').style.display = 'block';
            document.getElementById('calibrationProgress').classList.remove('active');
            
            // Hide main app, show calibration
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('calibrationScreen').classList.add('active');
        }

        function togglePrecisionMode() {
            precisionMode = !precisionMode;
            
            if (precisionMode) {
                // Store current data to localStorage
                webgazer.saveDataAcrossSessions(true);
                document.getElementById('togglePrecisionBtn').textContent = 'üîç Precision Mode: ON';
                console.log('‚úÖ Precision mode enabled');
            } else {
                document.getElementById('togglePrecisionBtn').textContent = 'üîç Precision Mode: OFF';
                console.log('‚è∏Ô∏è Precision mode disabled');
            }
        }

        function updateGazeCursor(x, y) {
            const cursor = document.getElementById('gazeCursor');
            cursor.style.left = x + 'px';
            cursor.style.top = y + 'px';
        }

        function checkGazeTargets(gazeX, gazeY) {
            const targets = document.querySelectorAll('.target-box');
            
            targets.forEach(target => {
                const rect = target.getBoundingClientRect();
                const isGazed = 
                    gazeX >= rect.left &&
                    gazeX <= rect.right &&
                    gazeY >= rect.top &&
                    gazeY <= rect.bottom;
                
                if (isGazed) {
                    target.classList.add('gazed');
                    
                    // Start dwell timer
                    const targetId = target.dataset.id;
                    if (!dwellTimers[targetId]) {
                        dwellTimers[targetId] = setTimeout(() => {
                            onDwellClick(target);
                            dwellTimers[targetId] = null;
                        }, DWELL_TIME);
                    }
                } else {
                    target.classList.remove('gazed');
                    
                    // Cancel dwell timer
                    const targetId = target.dataset.id;
                    if (dwellTimers[targetId]) {
                        clearTimeout(dwellTimers[targetId]);
                        dwellTimers[targetId] = null;
                    }
                }
            });
        }

        function onDwellClick(target) {
            clickCount++;
            console.log('üëÅÔ∏è Dwell click on target:', target.dataset.id);
            
            // Update UI
            document.getElementById('clickCount').textContent = clickCount;
            document.getElementById('clickIndicator').classList.add('active');
            setTimeout(() => {
                document.getElementById('clickIndicator').classList.remove('active');
            }, 200);
            
            // Visual feedback on cursor
            const cursor = document.getElementById('gazeCursor');
            cursor.classList.add('clicking');
            setTimeout(() => cursor.classList.remove('clicking'), 300);
            
            // Visual feedback on target
            target.classList.add('clicked');
            setTimeout(() => target.classList.remove('clicked'), 500);
            
            // Change emoji
            const emojis = ['üéØ','‚≠ê','üíé','üé®','üöÄ','üéµ','üåà','üî•','‚ú®','üé™','üé≠','üé¨','üéÆ','üèÜ','üí´','üåü','üí•','üéâ'];
            target.firstChild.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (webgazer) {
                webgazer.end();
            }
        });

        // Start the app
        window.addEventListener('load', init);
    </script>
</body>
</html>
